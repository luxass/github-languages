name: Update GitHub Languages

on:
  workflow_dispatch:
    inputs:
      dry-run:
        description: Run the workflow without creating a pull request
        required: false
        default: false
        type: boolean
  schedule:
    - cron: "0 0 * * *"

jobs:
  update-github-languages:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
      pull-requests: write
    if: github.repository_owner == 'luxass'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

      - name: setup node
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: lts/*

      - name: install dependencies
        run: pnpm install

      - name: old github languages
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        id: old-github-languages
        with:
          script: |
            const { generateOldLanguages } = await import('${{ github.workspace }}/.github/scripts/update-languages.mjs')
            await generateOldLanguages({ github, context, core })

      - name: download github languages
        run: |
          echo "" > .env
          pnpm run languages:download
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: generate diff
        id: generate-diff
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const { generateDiff } = await import('${{ github.workspace }}/.github/scripts/update-languages.mjs')
            await generateDiff({ github, context, core })

      - name: generate pr metadata (ai)
        id: pr-metadata
        if: ${{ steps.generate-diff.outputs.DIFF != '' && github.event.inputs.dry-run != 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SYSTEM_PROMPT: |
            You are an expert at analyzing code changes and generating structured data for pull request titles.

            Your task is to analyze the provided git diff and generate a JSON object with the following properties:
            - type: The conventional commit type (feat, fix, chore, docs, style, refactor)
            - scope: The scope of the change (e.g., component or section name). Use empty string if no specific scope.
            - message: A concise description of the change, under 72 characters total for the full title.

            Guidelines for the message:
            - Be specific about what was added/changed/fixed
            - Focus on the user-facing impact or technical improvement
            - Use present tense, imperative mood
            - Keep the full formatted title (type(scope): message) under 72 characters

            IMPORTANT Guidelines for scope:
            - NEVER use generic terms like 'schema', 'graphql', 'api', or 'types'
            - Look for specific entity or component names in the diff (e.g., 'user', 'repository', 'issue')
            - If changes span multiple specific components, use empty string for scope
            - Prefer empty string over vague or project-level scopes
            - Examples of good scopes: 'user', 'repository', 'workflow', 'organization'
            - Examples of bad scopes: 'schema', 'graphql', 'types', 'api', 'data'
          REQUEST_TEMPLATE: |
            {
              "messages": [
                { "role": "system", "content": "" },
                { "role": "user", "content": "" }
              ],
              "model": "openai/gpt-4o",
              "response_format": {
                "type": "json_schema",
                "json_schema": {
                  "name": "pr-title",
                  "strict": true,
                  "schema": {
                    "type": "object",
                    "properties": {
                      "type": { "type": "string", "enum": ["feat", "fix", "chore", "docs", "style", "refactor"] },
                      "scope": { "type": "string" },
                      "message": { "type": "string" }
                    },
                    "additionalProperties": false,
                    "required": ["type", "scope", "message"]
                  }
                }
              }
            }

        run: |
          set -euo pipefail

          DIFF_CONTENT=$(cat github-schema.diff)

          # Build the request JSON using jq to safely insert the prompt and diff into the REQUEST_TEMPLATE.
          REQUEST_JSON=$(jq --arg system "$SYSTEM_PROMPT" --arg diff "$DIFF_CONTENT" '.messages[0].content=$system | .messages[1].content=("Please analyze this git diff and generate an appropriate PR title.\n\n" + $diff)' <<< "$REQUEST_TEMPLATE")

          # Call the GitHub models API via gh and capture the output (read request from stdin)
          RESPONSE=$(printf '%s' "$REQUEST_JSON" | gh api --hostname models.github.ai -X POST /inference/chat/completions --input -)

          # Extract the generated JSON content and build the title
          CONTENT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')

          TYPE=$(echo "$CONTENT" | jq -r '.type')
          SCOPE=$(echo "$CONTENT" | jq -r '.scope')
          MESSAGE=$(echo "$CONTENT" | jq -r '.message')
          TITLE="$TYPE${SCOPE:+($SCOPE)}: $MESSAGE"

          echo "âœ… Generated PR title: $TITLE"
          echo "title=$TITLE" >> "$GITHUB_OUTPUT"

      - name: create pull request
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8.0.0
        if: ${{ github.event.inputs.dry-run != 'true' }}
        env:
          COMMIT_MESSAGE: "${{ steps.pr-metadata.outputs.title || 'feat: updated github languages' }}"
          NEW_LANGUAGES: ${{ steps.generate-diff.outputs.result-new-languages }}
          REMOVED_LANGUAGES: ${{ steps.generate-diff.outputs.result-removed-languages }}
        with:
          commit-message: ${{ env.COMMIT_MESSAGE }}
          title: ${{ env.COMMIT_MESSAGE }}
          body: |
            I found some new changes in GitHub's Linguist Repository.

            I don't know what they changed, but I'm sure it's important.
            If you want you can go take a look yourself.

            ${{ env.NEW_LANGUAGES }}
            ${{ env.REMOVED_LANGUAGES }}

            I will be waiting for your approval ðŸ‘‹.

            This is an automated PR to update GitHub Languages.
          branch: update-github-languages
          add-paths: languages.json,src/languages.ts
          base: main
          committer: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          author: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          reviewers: luxass
